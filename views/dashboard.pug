doctype html
html
	head
		title Hexo 管理 仪表盘
		<!--Import Google Icon Font-->
		link(rel="stylesheet", href="https://fonts.googleapis.com/icon?family=Material+Icons")
		<!--Import materialize.css-->
		link(rel="stylesheet", href="/static/css/materialize.min.css", media="screen, projection")
		link(rel="stylesheet", href="/static/css/customize.css")
		<!--Let browser know website is optimized for mobile-->
		meta(name="viewport", content="width=device-width, initial-scale=1.0")
	body
		header
			nav.top-nav
				.container
					.nav-wrapper
						a.page-title 仪表盘
			ul.side-nav.fixed
				li
					a.nav-logo(href="/")
						i.material-icons local_cafe
						| Hexo后台管理
				li
					.divider
				li
					a.subheader 管理
				li.active
					a.waves-effect.white-text(href="/!") 仪表盘
				li
					a.waves-effect(href="/!post") 文章
				li
					a.waves-effect(href="/!page") 页面
				li
					a.waves-effect(href="/!logout") 登出
				li
					.divider
				li
					a.subheader 其它
				li
					a.waves-effect(href="/#!") 统计
				li
					a.waves-effect(href="/#!") 关于
		main
			.container
				.row
					.col.s12.m9.l10
						.section
							p.caption 共有 #{postCounts} 篇文章，#{pageCounts} 个页面。
							h2.header 浏览
							a.waves-effect.waves-light.btn-large(href="/!post")
								i.material-icons.left note
								| 文章
							a.waves-effect.waves-light.btn-large(href="/!page")
								i.material-icons.left pages
								| 页面
						.section
							h2.header 创作
							a.waves-effect.waves-light.btn-large.modal-trigger(href="#modalPost")
								i.material-icons.left note
								| 新文章
							a.waves-effect.waves-light.btn-large.modal-trigger(href="#modalPage")
								i.material-icons.left pages
								| 新页面
							.modal#modalPost
								.modal-content
									h4 文件名
									input#postFilename(type="text" placeholder="文件名")
								.modal-footer
									a.modal-action.modal-close.waves-effect.waves-red.btn-flat 取消
									a.modal-action.modal-close.waves-effect.waves-green.btn-flat#postButton 提交
							.modal#modalPage
								.modal-content
									h4 文件名
									input#pageFilename(type="text" placeholder="文件名")
								.modal-footer
									a.modal-action.modal-close.waves-effect.waves-red.btn-flat 取消
									a.modal-action.modal-close.waves-effect.waves-green.btn-flat#pageButton 提交
						.section
							h2.header 管理
							p.caption 文章发布请先进行创作。
							a.waves-effect.waves-light.btn-large#generate
								i.material-icons.left build
								| 生成
							a.waves-effect.waves-light.btn-large#deploy
								i.material-icons.left cloud_circle
								| 部署
							a.waves-effect.waves-light.btn-large.modal-trigger(href="#hexoClean")
								i.material-icons.left delete_sweep
								| 清理
							.modal#hexoClean
								.modal-content
									h4 您确定清理生成文件夹吗？
									p 删除操作将无法撤销。
								.modal-footer
									a.modal-action.modal-close.waves-effect.waves-red.btn-flat 取消
									a.modal-action.modal-close.waves-effect.waves-green.btn-flat#delete 确认
							.modal#hexoGenerate
								.modal-content
									h4 生成中···
									.progress
										.indeterminate
							.modal#hexoDeploy
								.modal-content
									h4 部署中···
									.progress
										.indeterminate
									.console#deployConsole
		script(src="/static/js/jquery-3.2.1.min.js", type="text/javascript")
		script(src="/static/js/materialize.min.js", type="text/javascript")
		script.
			$('.modal').modal()
			$('#hexoGenerate').modal({
				dismissible: false
			})
			$('#hexoDeploy').modal({
				dismissible: false
			})
			var post = function() {
				var payload = {
					type: 'post',
					title: $("#postFilename").val()
				}
				fetch('/!new', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(payload),
					credentials: 'include'
				})
				.then(response => {
					$("#postFilename").val('')
					if (response.status == 200) {
						var $toastContent = $('<span><b>创建成功！</b></span>').add($('<i class="material-icons right">check</i>'))
						Materialize.toast($toastContent, 1000, '', () => {
							window.location.href = '/!post'
						})
					}
					else {
						var $toastContent = $('<span style="color: red;"><b>创建失败！</b></span>').add($('<i class="material-icons right">clear</i>'))
						Materialize.toast($toastContent, 3000)
					}
				})
			}

			var page = function() {
				var payload = {
					type: 'page',
					title: $("#pageFilename").val()
				}
				fetch('/!new', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(payload),
					credentials: 'include'
				})
				.then(response => {
					$("#postFilename").val('')
					if (response.status == 200) {
						var $toastContent = $('<span><b>创建成功！</b></span>').add($('<i class="material-icons right">check</i>'))
						Materialize.toast($toastContent, 1000, '', () => {
							window.location.href = '/!page'
						})
					}
					else {
						var $toastContent = $('<span style="color: red;"><b>创建失败！</b></span>').add($('<i class="material-icons right">clear</i>'))
						Materialize.toast($toastContent, 3000)
					}
				})
			}

			var clean = function() {
				var payload = {
					clean: true
				}
				fetch('/!clean', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(payload),
					credentials: 'include'
				})
				.then(response => {
					if (response.status == 200) {
						var $toastContent = $('<span><b>清理成功！</b></span>').add($('<i class="material-icons right">check</i>'))
						Materialize.toast($toastContent, 3000)
					}
					else {
						var $toastContent = $('<span style="color: red;"><b>清理失败！生成文件夹可能不存在。</b></span>').add($('<i class="material-icons right">clear</i>'))
						Materialize.toast($toastContent, 3000)
					}
				})
			}

			var generate = function() {
				$("#hexoGenerate").modal('open')
				fetch('/!generate', {
					method: 'GET',
					credentials: 'include'
				})
				.then(response => {
					if (response.status == 200) {
						var $toastContent = $('<span><b>生成成功！</b></span>').add($('<i class="material-icons right">check</i>'))
						$("#hexoGenerate").modal('close')
						Materialize.toast($toastContent, 3000)
					}
					else {
						var $toastContent = $('<span style="color: red;"><b>生成失败！</b></span>').add($('<i class="material-icons right">clear</i>'))
						$("#hexoGenerate").modal('close')
						Materialize.toast($toastContent, 3000)
					}
				})
			}

			var deploy = function() {
				$("#hexoDeploy").modal('open')
				$("#hexoDeploy .modal-content h4").text('部署中···')
				$("#hexoDeploy .modal-content .progress").html('<div class="indeterminate"></div>')
				$("#hexoDeploy .modal-content #deployConsole").html('')
				$("#hexoDeploy .modal-footer").remove()
				fetch('/!deploy', {
					method: 'GET',
					credentials: 'include'
				})
				.then(response => response.json())
				.then((data) => {
					if (data.error || data.stderr) {
						$("#hexoDeploy .modal-content h4").text('部署执行错误')
						$("#hexoDeploy .modal-content .progress").html('<div class="determinate" style="width: 100%"></div>')
						if (data.error) $("#deployConsole").html('<p class="error">' + data.error + '</p>')
						if (data.stdout) $("#deployConsole").html('<p class="stdout">' + data.stdout + '</p>')
						if (data.stderr) $("#deployConsole").html('<p class="stderr">' + data.stderr + '</p>')
						$("#hexoDeploy").append('<div class="modal-footer"><a class="modal-action modal-close waves-effect waves-green btn-flat">关闭</a></div>')
					} else {
						$("#hexoDeploy .modal-content h4").text('部署执行成功')
						$("#hexoDeploy .modal-content .progress").html('<div class="determinate" style="width: 100%"></div>')
						if (data.stdout) $("#deployConsole").html('<p class="stdout">' + data.stdout + '</p>')
						$("#hexoDeploy").append('<div class="modal-footer"><a class="modal-action modal-close waves-effect waves-green btn-flat">关闭</a></div>')
					}
				})
				.catch((err) => {
					var $toastContent = $('<span style="color: red;"><b>部署结果解析失败！</b></span>').add($('<i class="material-icons right">clear</i>'))
					$("#hexoDeploy").modal('close')
					Materialize.toast($toastContent, 3000)
				})
			}

			// Bind
			$("#postButton").click(post)
			$("#pageButton").click(page)
			$("#delete").click(clean)
			$("#generate").click(generate)
			$("#deploy").click(deploy)